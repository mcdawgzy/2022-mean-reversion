#region imports
from AlgorithmImports import *
#endregion

# Mean Reversion

# ------------------------------------------------------------
SYMBOL = "AUDNZD"
# ------------------------------------------------------------

class MeanReversion(QCAlgorithm):

    def Initialize(self):
        # Set dates
        self.SetStartDate(2004,5,1)
        self.SetEndDate(2022,5,31)

        # Set cash
        self.SetCash(100000)

        # Add asset
        self.symbol = self.AddForex(SYMBOL, Resolution.Daily).Symbol

        # Trade limiter - one per day
        self.tradeLimit = True

        # Add bollinger band
        self.Bolband = self.BB(SYMBOL, 20, 2, MovingAverageType.Simple, Resolution.Daily)

        # Add RSI
        self.rsi = self.RSI(SYMBOL, 13)

        # Set warmup period
        self.SetWarmUp(20)

    def OnData(self, data):
        if self.IsWarmingUp: return
        
        # Risk parameters
        price = self.Securities[SYMBOL].Close
        risk = self.Portfolio.TotalPortfolioValue / 100
        bbwidth = self.Bolband.UpperBand.Current.Value - self.Bolband.MiddleBand.Current.Value
        holdings = self.Portfolio[SYMBOL].Quantity

        if bbwidth == 0:
            return
        shareqty = Math.Round(risk / bbwidth)

        if self.IsWarmingUp:
            return

    # Buy if price closes below lower band
        if holdings == 0:
            if price < self.Bolband.LowerBand.Current.Value and self.rsi.Current.Value < 30:
                self.MarketOrder(SYMBOL, shareqty, tag="long entry")
                
        # Sell if price closes above the upper band
        if holdings == 0:
            if price > self.Bolband.UpperBand.Current.Value and self.rsi.Current.Value > 70:
                self.MarketOrder(SYMBOL, -shareqty, tag="short entry")

        # Long trade exit
        if holdings > 0:
            if self.rsi.Current.Value > 65:
                self.Liquidate(tag="long exit")

        # Short trade exit
        if holdings < 0:
            if self.rsi.Current.Value < 35:
                self.Liquidate(tag="short exit")
